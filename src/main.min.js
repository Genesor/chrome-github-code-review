function Main(){}function AppInteractionService(e,t,r){this.toolBarHeight=e,this.currentFileId=null,this.currentCommentId=null,this.files=this.getFiles(),this.hotKeysService=t,this.main=r}function DecorationService(e){this.element=e}function HierarchyGeneratorService(){this.cnt=0}function HotKeysService(){this.diffNext=74,this.diffPrev=75,this.commentNext=78,this.commentPrev=80,this.toggleSidebar=90;var e=this;"undefined"!=typeof chrome&&(chrome.storage.local.get("hotkeys",function(t){t.hasOwnProperty("hotkeys")&&e.updateHotkeys(t.hotkeys)}),chrome.storage.onChanged.addListener(function(t,r){t.hasOwnProperty("hotkeys")&&e.updateHotkeys(t.hotkeys.newValue)}))}Main.prototype.init=function(){this.hiddenSidebarUrls=[],this.pageLoadWaitTimeout=1e3,this.hotKeysService=new HotKeysService,this.generateApp(),window==top&&(window.addEventListener("keyup",this.doKeyPress.bind(this),!1),setInterval(this.monitorUrlChange.bind(this),100))},Main.prototype.generateApp=function(){this.currentPageUrl=this.getWindowLocationHref(),this.toolBarHeight=$(".pr-toolbar").height();var e=[];$.each($(".file"),function(t,r){var i=$(r).find(".file-header").data("path");i&&(e[t]=i)});var t=$('<p id="jk-hierarchy"></p>'),r=new HierarchyGeneratorService;r.generateAndApplyHierarchyHtml(e,t),$("body").prepend(t);var i=new DecorationService(t);i.applyInitStyle(),i.appendCommentCounts(),i.adjustBottomFileHeight(this.toolBarHeight),i.appendNoDiffMessage();var o=new AppInteractionService(this.toolBarHeight,this.hotKeysService,this);o.attachFolderCollapseBehavior(t),o.attachJumpOnClickBehavior(t),o.updateCurentDiffPos(),this.appInteractionService=o},Main.prototype.doKeyPress=function(e){var t=$(e.target).prop("tagName");"BODY"!=t&&void 0!=t||this.hotKeysService.isValidKeyCode(e.keyCode)&&this.appInteractionService.respondToHotKey(e.keyCode)},Main.prototype.monitorUrlChange=function(){this.isSameUrl()||(this.currentPageUrl=this.getWindowLocationHref(),$("#jk-hierarchy").remove())},Main.prototype.isSameUrl=function(){return this.currentPageUrl==this.getWindowLocationHref()},Main.prototype.getWindowLocationHref=function(){return window.location.href.split("#")[0]},AppInteractionService.prototype.attachFolderCollapseBehavior=function(e){$(e).find(".folder").click(function(){$header=$(this),$content=$header.next(),$content.slideToggle(10,function(){$header.toggleClass("collapsed")})})},AppInteractionService.prototype.attachJumpOnClickBehavior=function(e){var t=this;$(e).find(".jk-file").click(function(){t.scrollTo($("#"+$(this).data("file-id"))),t.currentFileId=$(this).data("file-id").split("-")[1]})},AppInteractionService.prototype.scrollTo=function(e){if($(e).length){var t=$(e).offset().top-this.toolBarHeight-10;$("body").scrollTop(t),this.updateCurentDiffPos()}},AppInteractionService.prototype.updateCurentDiffPos=function(){function e(){var e=$("#jk-hierarchy").find(".jk-file.current").position();return e&&e.top<0}function t(){var e=$("#jk-hierarchy").find(".jk-file.current").position();return e&&e.top>$("#jk-hierarchy").height()}var r=null;if($.each(this.getFiles(),function(e,t){var i=t.getBoundingClientRect();i.top<139&&(r=$(t).attr("id"))}),$("#jk-hierarchy").find(".jk-file.current").removeClass("current"),$("#jk-hierarchy").find('.jk-file*[data-file-id="'+r+'"]').addClass("current"),$("#jk-hierarchy").is(":visible")&&$("#jk-hierarchy").find(".jk-file.current").is(":visible")){for(;e();)$("#jk-hierarchy").scrollTop($("#jk-hierarchy").scrollTop()-10);for(;t();)$("#jk-hierarchy").scrollTop($("#jk-hierarchy").scrollTop()+10)}},AppInteractionService.prototype.getFiles=function(){return $(".file")},AppInteractionService.prototype.getComments=function(){return $("#files .js-comment")},AppInteractionService.prototype.getCurrentEl=function(){var e=this.getFiles();return e[this.currentFileId]},AppInteractionService.prototype.updateCurrentPos=function(e){null==this.currentFileId?this.currentFileId=0:this.currentFileId<this.files.length-1&&e==this.hotKeysService.getKeyCodeForNextDiff()?this.currentFileId++:this.currentFileId>0&&e==this.hotKeysService.getKeyCodeForPrevDiff()&&this.currentFileId--},AppInteractionService.prototype.updateCurrentCommentPos=function(e){null==this.currentCommentId?this.currentCommentId=0:this.currentCommentId<this.getComments().length-1&&e==this.hotKeysService.getKeyCodeForNextComment()?this.currentCommentId++:this.currentCommentId>0&&e==this.hotKeysService.getKeyCodeForPrevComment()&&this.currentCommentId--},AppInteractionService.prototype.getCurrentCommentEl=function(){return this.getComments()[this.currentCommentId]},AppInteractionService.prototype.respondToHotKey=function(e){if(this.hotKeysService.isValidKeyCodeForDiff(e)){this.updateCurrentPos(e);var t=this.getCurrentEl();return void this.scrollTo(t)}if(this.hotKeysService.isValidKeyCodeForComment(e)){this.updateCurrentCommentPos(e);var t=this.getCurrentCommentEl();return void this.scrollTo(t)}this.hotKeysService.isValidKeyCodeForSideBarToggle(e)&&(this.isSidebarHaveContents()||($("#jk-hierarchy").remove(),this.main.generateApp()),this.isSidebarHaveContents()?$("#jk-hierarchy").toggle():$("#jk-notice").show().delay(600).fadeOut(600))},AppInteractionService.prototype.isSidebarHaveContents=function(){return $("#jk-hierarchy").length&&$("#jk-hierarchy")[0].innerHTML},DecorationService.prototype.applyInitStyle=function(){$(this.element).css("width",1.2*$(this.element).width()),$(this.element).css("background-color",$("body").css("background-color")),$(this.element).hide()},DecorationService.prototype.adjustBottomFileHeight=function(e){var t=$(".file")[$(".file").length-1];if(t&&$(t).height()<$(window).height()){var r=$(window).height()-$(t).height()-e-100;r>0&&$(t).css("margin-bottom",r)}},DecorationService.prototype.appendCommentCounts=function(){var e=$("#jk-hierarchy").find(".jk-file");$.each(e,function(e,t){var r=$(t).data("file-id"),i=$("#"+r).find(".js-comment");if(i.length){var o=$('<span class="comment-count"> ('+i.length+")</span>");$(t).append(o)}})},DecorationService.prototype.appendNoDiffMessage=function(){$("#jk-notice").length||($("body").prepend('<div id="jk-notice">No diffs found</div>'),$("#jk-notice").css("background-color",$("body").css("background-color")))},HierarchyGeneratorService.prototype.generateAndApplyHierarchyHtml=function(e,t){this.files=e,this.element=t;var r=this.getCompressedHierarchy();this.generateAndApplyHtml(this.element,r)},HierarchyGeneratorService.prototype.getCompressedHierarchy=function(){var e=this.getHierarchyStructure(this.files);return this.compressHierarchy(e)},HierarchyGeneratorService.prototype.getHierarchyStructure=function(e){var t={};for(key in e){var r=e[key].split("/");this.addProp(t,r)}return t},HierarchyGeneratorService.prototype.addProp=function(e,t){if(1==t.length){var r=t.splice(0,1);return void(e[r[0]]=r[0])}if(t.length>1){var i=t.splice(0,1);e.hasOwnProperty(i)||(e[i]={}),this.addProp(e[i],t)}},HierarchyGeneratorService.prototype.compressHierarchy=function(e){function t(e,r,i){for(var o in e)i&&"string"==typeof e[o]||(i=i+String(o)+"/"),"string"!=typeof e[o]?"object"==typeof e[o]&&Object.keys(e[o]).length>1?(r[i]={},t(e[o],r[i],""),i=""):(t(e[o],r,i),i=""):(1==Object.keys(e).length?(r[i]={},r[i][String(o)+"/"]=e[o]):r[i]=e[o],i="")}var r={},i="";return t(e,r,i),r},HierarchyGeneratorService.prototype.generateAndApplyHtml=function(e,t){var r=$(document.createElement("ul")),i=this;$.each(t,function(o,n){var s="string"==typeof n?n:o,c=$("<li>"+s+"</li>");"object"==typeof t[o]?c.addClass("folder"):"string"==typeof t[o]&&(c=$('<li><span class="file-name">'+s+"</span></li>"),c.addClass("jk-file"),c.attr("data-file-id","diff-"+i.cnt),i.cnt=i.cnt+1),r.append(c),e.append(r),"object"==typeof t[o]&&i.generateAndApplyHtml(r,t[o])})},HotKeysService.prototype.updateHotkeys=function(e){this.diffNext=e.diffNext,this.diffPrev=e.diffPrev,this.commentNext=e.commentNext,this.commentPrev=e.commentPrev,this.toggleSidebar=e.toggleSidebar},HotKeysService.prototype.getKeyCodeForNextDiff=function(){return this.diffNext},HotKeysService.prototype.getKeyCodeForPrevDiff=function(){return this.diffPrev},HotKeysService.prototype.getKeyCodeForNextComment=function(){return this.commentNext},HotKeysService.prototype.getKeyCodeForPrevComment=function(){return this.commentPrev},HotKeysService.prototype.getKeyCodeForToggleSidebar=function(){return this.toggleSidebar},HotKeysService.prototype.isValidKeyCodeForDiff=function(e){return e==this.getKeyCodeForNextDiff()||e==this.getKeyCodeForPrevDiff()},HotKeysService.prototype.isValidKeyCodeForComment=function(e){return e==this.getKeyCodeForNextComment()||e==this.getKeyCodeForPrevComment()},HotKeysService.prototype.isValidKeyCodeForSideBarToggle=function(e){return e==this.getKeyCodeForToggleSidebar()},HotKeysService.prototype.isValidKeyCode=function(e){return this.isValidKeyCodeForDiff(e)||this.isValidKeyCodeForComment(e)||this.getKeyCodeForToggleSidebar(e)};